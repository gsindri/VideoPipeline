<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="no-referrer" />
  <title>VideoPipeline Studio</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
</head>
<body>
  <!-- ===== HOME VIEW ===== -->
  <div id="homeView" style="display:none">
    <header>
      <h1>VideoPipeline Studio</h1>
      <span class="muted">Home</span>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button data-action="actions-helper" title="Actions helper (tunnel URL + OpenAPI import URL)">‚ö° Actions</button>
        <button data-action="api-token" title="Set API token (VP_API_TOKEN)">üîë API Token</button>
      </div>
    </header>
    <main class="home-main">
      <section class="home-section">
        <div class="panel home-panel">
          <h2>Open Video</h2>
          <div class="row" style="gap:10px">
            <button class="primary" id="btnOpenDialog">Browse for video...</button>
          </div>
          <div class="row" style="margin-top:15px;gap:10px">
            <input type="text" id="videoPathInput" placeholder="Or paste video path here..." style="flex:1;min-width:300px" />
            <button id="btnOpenByPath">Open</button>
          </div>
          <p class="small" style="margin-top:10px">Select a video file to create or open its project.</p>
        </div>

        <div class="panel home-panel">
          <h2>Download from URL</h2>
          <div class="row" style="gap:10px;align-items:center">
            <input type="text" id="urlInput" placeholder="Paste YouTube/Twitch/etc URL..." style="flex:1;min-width:300px" />
            <button id="btnPasteUrl" title="Paste from clipboard">üìã</button>
            <button id="btnProbeUrl" title="Detect site info">üîç Probe</button>
            <button class="primary" id="btnDownloadUrl">Download</button>
          </div>
          <div id="probeBadge" style="margin-top:8px;padding:8px 12px;background:#2a3a4a;border-radius:4px;display:none">
            <span id="probeBadgeText" class="small" style="color:#7fdbff"></span>
          </div>
          <div class="row" style="margin-top:10px;gap:15px;align-items:center;flex-wrap:wrap">
            <label class="small" title="Creates a browser-friendly H.264/AAC preview/proxy if needed (helps playback in Studio)."><input type="checkbox" id="dlCreatePreview" checked /> Create preview</label>
            <label class="small" title="Prevents yt-dlp from downloading entire playlists/channels when a playlist URL is pasted."><input type="checkbox" id="dlNoPlaylist" checked /> No playlist</label>
            <label class="small" title="Print transcript to server console as it's transcribed"><input type="checkbox" id="dlWhisperVerbose" /> Verbose transcript</label>
            <label class="small" title="Run speaker diarization and add speaker labels to the transcript (requires pyannote-audio and HuggingFace token)"><input type="checkbox" id="dlDiarizeEnabled" checked /> Diarization (speakers)</label>
            <label class="small" title="Enable detailed internal logs (chat/emotes) for this download (DEBUG level)"><input type="checkbox" id="dlVerboseLogs" checked /> Verbose logs</label>
            <label class="small" style="display:flex;align-items:center;gap:5px">
              Speed:
              <select id="dlSpeedMode" style="padding:2px 6px">
                <option value="auto" selected>Auto (recommended)</option>
                <option value="conservative">Conservative (N=4)</option>
                <option value="balanced">Balanced (N=8)</option>
                <option value="fast">Fast (N=16)</option>
                <option value="aggressive">Aggressive (N=32)</option>
              </select>
            </label>
            <label class="small" style="display:flex;align-items:center;gap:5px">
              Quality:
              <select id="dlQualityCap" style="padding:2px 6px">
                <option value="source" selected>Source (best)</option>
                <option value="1080">1080p</option>
                <option value="720">720p</option>
                <option value="480">480p</option>
              </select>
            </label>
          </div>
          <p class="small" style="margin-top:8px;color:#888">
            <span id="dlHelpText">Paste a URL and click Download. Auto mode adapts speed per site.</span>
          </p>
        </div>

        <div class="panel home-panel">
          <h2>Jobs</h2>
          <div class="list" id="homeJobs">
            <div class="small">No active jobs.</div>
          </div>
        </div>

        <div class="panel home-panel">
          <h2>Videos</h2>
          <div class="row" style="margin-bottom:10px;gap:15px;align-items:center;flex-wrap:wrap">
            <label class="small" title="Show failed/incomplete projects (e.g., interrupted downloads).">
              <input type="checkbox" id="showNeedsAttention" />
              Show needs attention
            </label>
          </div>
          <div id="videoSelectionToolbar" style="display:none;margin-bottom:10px;padding:8px;background:#1a1d24;border-radius:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span id="videoSelectionCount" style="font-size:12px;color:#888">0 selected</span>
            <button id="btnSelectAll" class="small">Select All</button>
            <button id="btnDeselectAll" class="small">Deselect All</button>
            <button id="btnDeleteSelectedProjects" class="small" style="background:#ef4444;display:none">Delete Selected Projects</button>
            <button id="btnDeleteSelectedVideos" class="small" style="background:#dc2626">Delete Selected Videos</button>
          </div>
          <div class="list" id="recentVideos">
            <div class="small">Loading...</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== STUDIO VIEW ===== -->
  <div id="studioView" style="display:none">
    <header>
      <h1>VideoPipeline Studio</h1>
      <span class="muted" id="projectInfo">Loading project...</span>
      <div class="tab-bar" style="margin-left:20px">
        <button class="tab-btn active" data-tab="edit" id="tabEdit">Edit</button>
        <button class="tab-btn" data-tab="publish" id="tabPublish">Publish</button>
      </div>
      <button id="btnBackToHome" style="margin-left:20px" title="Back to Home">‚Üê Home</button>
      <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
        <button data-action="api-token" title="Set API token (VP_API_TOKEN)">üîë Token</button>
        <button data-action="actions-helper" title="Actions helper (tunnel URL + OpenAPI import URL)">‚ö° Actions</button>
        <span class="muted">
          Shortcuts: <kbd>Space</kbd> play/pause, <kbd>I</kbd> set start, <kbd>O</kbd> set end, <kbd>[</kbd>/<kbd>]</kbd> nudge ¬±0.5s
        </span>
      </div>
    </header>

    <!-- Edit Tab Content -->
    <main id="editTabContent">
      <section id="left">
        <div class="panel" id="chatTimelinePanel" data-panel="chat_timeline" style="display:none">
          <h2>Chat timeline</h2>
          <div class="panel-content">
            <div id="chatMiniTimelineWrap" class="chat-mini-timeline" style="display:none" title="Click to seek ‚Ä¢ Scroll to zoom ‚Ä¢ Drag to pan">
              <canvas id="chatMiniTimeline"></canvas>
              <div class="playhead" id="chatTimelinePlayhead"></div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h2>Source video</h2>
          <div class="video-wrap">
            <video id="video" controls preload="metadata" src="/video"></video>
            <canvas id="facecamCanvas" class="overlay-canvas"></canvas>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="btnSetStart">Set Start = current</button>
            <button id="btnSetEnd">Set End = current</button>
            <button id="btnSnapCandidate" title="Snap in/out to candidate">Snap to candidate</button>
            <span class="small" id="timeReadout"></span>
          </div>
        </div>

        <div class="panel" data-panel="layout">
          <h2>Layout</h2>
          <div class="panel-content">
          <div class="row">
            <button class="primary" id="btnCalibrateFacecam">Calibrate facecam</button>
            <button id="btnSaveFacecam" disabled>Save facecam</button>
            <span class="small" id="facecamStatus">No facecam calibration yet.</span>
          </div>
          <p class="small">Draw a rectangle around the facecam. Saved as normalized coordinates.</p>
          </div>
        </div>

        <div class="panel" data-panel="timeline">
          <h2>Interest timeline</h2>
          <div class="panel-content">
          <div class="row">
            <button class="success" id="btnAnalyzeFull" title="Run all analysis stages in parallel (recommended)">‚ö° Analyze (Full)</button>
            <label title="What type of content is this? Helps the AI understand what makes a good clip.">Content:
              <select id="contentType">
                <option value="gaming" selected>Gaming/Streaming</option>
                <option value="reaction">Reaction/Commentary</option>
                <option value="podcast">Podcast/Interview</option>
                <option value="irl">IRL/Vlog</option>
                <option value="music">Music/Performance</option>
                <option value="educational">Educational/Tutorial</option>
              </select>
            </label>
            <label title="How much motion (frame changes) affects highlight detection. 'Off' is best for podcasts/chatting, 'Low' is recommended for gaming.">Motion:
              <select id="motionWeightMode">
                <option value="off" selected>Off</option>
                <option value="low">Low</option>
                <option value="normal">Normal</option>
                <option value="high">High</option>
              </select>
            </label>
            <label title="Which speech-to-text engine to use. openai-whisper with GPU (AMD ROCm / NVIDIA CUDA) is recommended.">Whisper:
              <select id="whisperBackend">
                <option value="openai_whisper" selected>openai-whisper</option>
                <option value="faster_whisper">faster-whisper</option>
                <option value="whispercpp">whisper.cpp</option>
                <option value="auto">auto</option>
              </select>
            </label>
            <div class="dropdown" style="position:relative">
              <button id="btnAnalysisTools" title="Show/hide individual analysis tools">üîß Tools ‚ñæ</button>
              <div id="analysisToolsDropdown" class="dropdown-menu" style="display:none;position:absolute;top:100%;left:0;background:#1a1d24;border:1px solid var(--border);border-radius:6px;padding:8px;z-index:100;min-width:180px;margin-top:4px">
                <label class="dropdown-item" style="display:flex;align-items:center;gap:8px;padding:4px 0;cursor:pointer;font-size:12px">
                  <input type="checkbox" id="showBtnHighlights" /> Analyze highlights
                </label>
                <label class="dropdown-item" style="display:flex;align-items:center;gap:8px;padding:4px 0;cursor:pointer;font-size:12px">
                  <input type="checkbox" id="showBtnAudio" /> Audio only
                </label>
                <label class="dropdown-item" style="display:flex;align-items:center;gap:8px;padding:4px 0;cursor:pointer;font-size:12px">
                  <input type="checkbox" id="showBtnAudioEvents" /> Audio events
                </label>
                <label class="dropdown-item" style="display:flex;align-items:center;gap:8px;padding:4px 0;cursor:pointer;font-size:12px">
                  <input type="checkbox" id="showBtnSpeech" /> Speech
                </label>
                <label class="dropdown-item" style="display:flex;align-items:center;gap:8px;padding:4px 0;cursor:pointer;font-size:12px">
                  <input type="checkbox" id="showBtnContext" /> Context + Titles (AI)
                </label>
                <hr style="border:0;border-top:1px solid var(--border);margin:8px 0">
                <div style="font-size:11px;color:#888;margin-bottom:4px">GPU Memory</div>
                <div id="gpuMemoryStatus" style="font-size:11px;color:#888;margin-bottom:6px">Loading...</div>
                <button id="btnClearGpuMemory" style="width:100%;font-size:11px;padding:4px 8px">üßπ Clear GPU Memory</button>
              </div>
            </div>
            <button class="primary analysis-btn-optional" id="btnAnalyzeHighlights">Analyze highlights</button>
            <button class="analysis-btn-optional" id="btnAnalyzeAudio">Audio only</button>
            <button class="analysis-btn-optional" id="btnAnalyzeAudioEvents" title="Detect laughter, cheering, shouting events">Audio events</button>
            <button class="analysis-btn-optional" id="btnAnalyzeSpeech" title="Transcribe with Whisper and extract speech/reaction features">Speech</button>
            <button class="analysis-btn-optional" id="btnAnalyzeContext" title="Generate clip variants and AI titles/hooks">Context + Titles (AI)</button>
            <button id="btnResetAnalysis" class="danger" title="Delete analysis data and start fresh">üóë Reset Analysis</button>
          </div>
          <div class="row" style="margin-top:6px;gap:14px">
            <label title="Run speaker diarization and add speaker labels to the transcript (requires pyannote-audio and HuggingFace token)">
              <input type="checkbox" id="diarizeEnabled" checked /> Diarization
            </label>
            <label title="Hint: minimum expected speakers (leave blank for auto)">Min speakers:
              <input type="number" id="diarizeMinSpeakers" min="1" step="1" placeholder="auto" style="width:90px;padding:6px 8px" />
            </label>
            <label title="Hint: maximum expected speakers (leave blank for auto). Setting this can prevent the model from inventing too many speakers.">Max speakers:
              <input type="number" id="diarizeMaxSpeakers" min="1" step="1" placeholder="auto" style="width:90px;padding:6px 8px" />
            </label>
            <a class="small" id="lnkViewDiarization" href="/api/task_artifact/diarization" target="_blank" rel="noopener" title="View current analysis/diarization.json (if it exists)">View diarization.json</a>
            <label title="Print transcript to server console as it's transcribed (useful for monitoring progress)">
              <input type="checkbox" id="whisperVerbose" /> Verbose transcript
            </label>
            <label title="Log a stack trace the first time TensorFlow/tf_keras is imported (debugging noisy protobuf/TensorFlow warnings)">
              <input type="checkbox" id="traceTfImports" /> Trace TF imports
            </label>
          </div>
          <div class="row">
            <span class="small" id="analysisStatus"></span>
          </div>
          
          <!-- Interactive Timeline Controls -->
          <div class="timeline-controls">
            <button id="btnZoomIn" title="Zoom in (scroll wheel also works)">üîç+ Zoom In</button>
            <button id="btnZoomOut" title="Zoom out">üîç- Zoom Out</button>
            <button id="btnResetZoom" title="Reset to full view">‚Ü∫ Reset View</button>
            <label class="small" style="display:flex;align-items:center;gap:4px">
              <input type="checkbox" id="showCandidateSegments" checked /> Show candidates
            </label>
            <label class="small" style="display:flex;align-items:center;gap:4px">
              <input type="checkbox" id="showClipHandles" checked /> Show clip region
            </label>
            <span class="zoom-info" id="zoomInfo">100% ‚Ä¢ Drag to pan, scroll to zoom</span>
          </div>
          
          <!-- Timeline with overlays -->
          <div class="timeline-container">
            <div class="timeline-canvas-wrap">
              <canvas id="chart" height="140"></canvas>
              <div class="timeline-segments-overlay" id="timelineSegments"></div>
              <div class="timeline-clip-overlay" id="timelineClipOverlay">
                <div class="clip-region" id="clipRegion" style="display:none">
                  <div class="clip-handle start" id="clipHandleStart" title="Drag to adjust start time"></div>
                  <div class="clip-handle end" id="clipHandleEnd" title="Drag to adjust end time"></div>
                </div>
              </div>
              <div class="timeline-playhead" id="timelinePlayhead" style="display:none"></div>
            </div>
            
            <div class="timeline-legend">
              <div class="timeline-legend-item">
                <div class="legend-color high"></div>
                <span>High score</span>
              </div>
              <div class="timeline-legend-item">
                <div class="legend-color medium"></div>
                <span>Medium score</span>
              </div>
              <div class="timeline-legend-item">
                <div class="legend-color low"></div>
                <span>Low score</span>
              </div>
              <div class="timeline-legend-item">
                <div class="legend-color clip"></div>
                <span>Clip region</span>
              </div>
            </div>
          </div>
          
          <p class="small" style="margin-top:8px">Higher score = more hype. <strong>Click segments</strong> to load candidates, <strong>drag edges</strong> to fine-tune. Use clip handles to set clip boundaries directly on timeline.</p>
          </div>
        </div>

        <div class="panel collapsed" data-panel="pipelinestatus">
          <h2>üìä Analysis Pipeline Status</h2>
          <div class="panel-content">
            <div id="pipelineStatus" style="font-size:12px">
              <div class="small">No analysis data yet. Run "Analyze (Full)" to start.</div>
            </div>
          </div>
        </div>

        <div class="panel" data-panel="jobs">
          <h2>Jobs</h2>
          <div class="panel-content">
          <div class="list" id="jobs"></div>
          </div>
        </div>

        <div class="panel" data-panel="clipbuilder">
          <h2>Clip builder</h2>
          <div class="panel-content">
          <div class="row">
            <label>Start (s)
              <input type="number" id="startS" step="0.1" />
            </label>
            <label>End (s)
              <input type="number" id="endS" step="0.1" />
            </label>
            <label>Title
              <input type="text" id="title" placeholder="Optional title" style="width:260px" />
            </label>
            <label>Template
              <select id="template">
                <option value="vertical_blur">vertical_blur (gaming default)</option>
                <option value="vertical_streamer_pip">vertical_streamer_pip (facecam PIP)</option>
                <option value="vertical_streamer_split">vertical_streamer_split (facecam split)</option>
                <option value="vertical_crop_center">vertical_crop_center</option>
                <option value="original">original</option>
              </select>
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="primary" id="btnSaveSelection">Save selection</button>
            <button id="btnNudgeBack">‚óÄ -0.5s</button>
            <button id="btnNudgeFwd">+0.5s ‚ñ∂</button>
            <span class="small">Tip: fine-tune with arrow keys in the inputs.</span>
          </div>
          
          <!-- AI Suggestions Panel -->
          <div id="aiSuggestionsPanel" class="ai-suggestions-panel" style="display:none">
            <div class="ai-suggestions-header">
              <h3>ü§ñ AI Suggestions <span id="aiModelBadge" class="ai-model-badge"></span></h3>
              <button id="btnRegenerateAI" class="ai-regenerate-btn" title="Generate new suggestions">‚Üª Regenerate</button>
            </div>
            
            <!-- Title suggestions -->
            <div class="ai-suggestion-group">
              <div class="ai-suggestion-label">Title Options</div>
              <div class="ai-suggestion-options" id="aiTitleOptions"></div>
            </div>
            
            <!-- Hook suggestions -->
            <div class="ai-suggestion-group">
              <div class="ai-suggestion-label">Hook (Video Overlay)</div>
              <div class="ai-suggestion-options" id="aiHookOptions"></div>
            </div>
            
            <!-- Hashtags -->
            <div class="ai-suggestion-group">
              <div class="ai-suggestion-label">Hashtags</div>
              <div class="ai-tags-row" id="aiHashtags"></div>
            </div>
            
            <button id="btnApplyAISuggestions" class="ai-apply-btn">Apply Selected Suggestions</button>
          </div>
          
          </div>
        </div>
      </section>

      <section id="right">
        <div class="panel" id="chatPanel" data-panel="chat">
          <h2>Chat Replay</h2>
          <div class="panel-content">
          <div class="row" style="margin-bottom:10px;gap:8px;flex-wrap:wrap">
            <input type="text" id="chatSourceUrl" placeholder="Source URL (Twitch VOD, YouTube...)" style="flex:1;min-width:200px" />
            <button class="primary" id="btnDownloadChat">Download Chat</button>
            <button id="btnClearChat" style="display:none">Clear</button>
          </div>
          <div id="chatOffsetControls" class="row" style="margin-bottom:10px;gap:8px;align-items:center;display:none">
            <label style="display:flex;align-items:center;gap:5px">
              Offset (ms):
              <button id="chatNudgeBack" style="padding:2px 8px">-1s</button>
              <input type="number" id="chatOffsetMs" value="0" style="width:80px" />
              <button id="chatNudgeFwd" style="padding:2px 8px">+1s</button>
            </label>
            <label style="font-size:0.85em"><input type="checkbox" id="chatAutoScroll" checked /> Auto-scroll</label>
          </div>
          
          <!-- Chat Filter Controls -->
          <div id="chatFilterControls" class="chat-filter-controls" style="display:none">
            <label>Filter:
              <select id="chatFilterPreset">
                <option value="">All messages</option>
                <option value="laughter">üòÇ Laughter/LOL</option>
                <option value="excitement">üî• Excitement/Hype</option>
                <option value="questions">‚ùì Questions</option>
                <option value="emotes">‚ú® Emotes only</option>
                <option value="custom">Custom...</option>
              </select>
            </label>
            <label id="chatCustomFilterWrap" style="display:none">Keywords:
              <input type="text" id="chatFilterKeywords" placeholder="word1, word2..." />
            </label>
            <label style="font-size:0.85em">
              <input type="checkbox" id="chatFilterHighlightOnly" /> Highlight only
            </label>
            <span id="chatFilterCount" class="chat-filter-badge" style="display:none">
              <span class="count">0</span> matches
              <span class="remove-filter" title="Clear filter">‚úï</span>
            </span>
          </div>
          
          <div class="small" id="chatStatus">No chat replay available.</div>
          <div class="chat-messages" id="chatMessages"></div>
          <p class="small" style="margin-top:8px;opacity:0.7">Click a message to seek. Use offset to sync chat with video.</p>
          </div>
        </div>

        <div class="panel" data-panel="candidates">
          <h2>Top candidates</h2>
          <div class="panel-content">
          <div class="list" id="candidates"></div>
          </div>
        </div>

        <div class="panel" data-panel="batch">
          <h2>Batch actions</h2>
          <div class="panel-content">
          <div class="row">
            <label>Top N
              <input type="number" id="batchTopN" value="10" min="1" />
            </label>
            <label>Template
              <select id="batchTemplate">
                <option value="vertical_streamer_pip">vertical_streamer_pip</option>
                <option value="vertical_streamer_split">vertical_streamer_split</option>
                <option value="vertical_blur">vertical_blur</option>
                <option value="vertical_crop_center">vertical_crop_center</option>
                <option value="original">original</option>
              </select>
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="primary" id="btnCreateSelections">Create selections from top candidates</button>
            <button id="btnBatchExport">Batch export selections</button>
          </div>
          <p class="small">Creates selections from top highlight candidates, then exports them sequentially.</p>
          </div>
        </div>

        <div class="panel" data-panel="selections">
          <h2>Selections</h2>
          <div class="panel-content">
          <div class="list" id="selections"></div>
          </div>
        </div>

        <div class="panel" data-panel="export">
          <h2>Export</h2>
          <div class="panel-content">
          <div class="row">
            <label>Width
              <input type="number" id="expW" value="1080" />
            </label>
            <label>Height
              <input type="number" id="expH" value="1920" />
            </label>
            <label>FPS
              <input type="number" id="expFps" value="30" />
            </label>
            <label>CRF
              <input type="number" id="expCrf" value="20" />
            </label>
            <label>Preset
              <select id="expPreset">
                <option>veryfast</option>
                <option>faster</option>
                <option>fast</option>
                <option>medium</option>
              </select>
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <label><input type="checkbox" id="withCaptions" /> Burn-in captions (Whisper)</label>
            <label><input type="checkbox" id="normalizeAudio" /> Normalize audio</label>
          </div>
          <p class="small">Captions require optional dependency: <code>pip install -e '.[whisper]'</code></p>
          </div>
        </div>
      </section>
    </main>

    <!-- Publish Tab Content -->
    <main id="publishTabContent" style="display:none">
      <section id="publishLeft">
        <div class="panel">
          <h2>Accounts</h2>
          <div class="row" style="margin-bottom:10px">
            <select id="publishPlatformFilter">
              <option value="">All platforms</option>
              <option value="youtube">YouTube</option>
              <option value="tiktok">TikTok</option>
            </select>
            <input type="text" id="publishAccountSearch" placeholder="Search accounts..." style="flex:1" />
          </div>
          <div class="list" id="publishAccounts">
            <div class="small">Loading accounts...</div>
          </div>
          <div id="noAccountsCard" class="panel" style="display:none;margin-top:12px;background:#1a1e24">
            <p class="small">No accounts connected yet.</p>
            <p class="small">Add an account via CLI:</p>
            <code class="small" style="display:block;padding:8px;background:#0f1318;border-radius:6px;margin-top:8px;word-break:break-all">vp accounts add youtube --client-secrets "path/to/client_secret.json" --label "My Channel"</code>
            <button id="btnCopyAccountCmd" style="margin-top:8px">Copy command</button>
          </div>
        </div>

        <div class="panel">
          <h2>Publish Options</h2>
          <div class="row">
            <label>Privacy
              <select id="publishPrivacy">
                <option value="private">Private</option>
                <option value="unlisted">Unlisted</option>
                <option value="public">Public</option>
              </select>
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <label style="width:100%">Title override (optional)
              <input type="text" id="publishTitleOverride" placeholder="Leave blank to use metadata title" style="width:100%" />
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <label style="width:100%">Description override (optional)
              <textarea id="publishDescOverride" placeholder="Leave blank to use metadata description" rows="3" style="width:100%;resize:vertical"></textarea>
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <label style="width:100%">Append hashtags (optional)
              <input type="text" id="publishHashtags" placeholder="#shorts #gaming" style="width:100%" />
            </label>
          </div>
          <details style="margin-top:12px">
            <summary class="small" style="cursor:pointer">Batch options</summary>
            <div class="row" style="margin-top:10px">
              <label>Stagger (seconds between posts)
                <input type="number" id="publishStagger" value="0" min="0" />
              </label>
            </div>
          </details>
        </div>

        <div class="panel">
          <h2>Actions</h2>
          <div class="row">
            <button class="primary" id="btnQueuePublish">Queue publish</button>
            <span class="small" id="publishSelectionInfo">Select exports and accounts above</span>
          </div>
        </div>
      </section>

      <section id="publishRight">
        <div class="panel">
          <h2>Exports</h2>
          <div class="list" id="publishExports">
            <div class="small">Loading exports...</div>
          </div>
        </div>

        <div class="panel">
          <h2>Publish Jobs</h2>
          <div class="list" id="publishJobs">
            <div class="small">No jobs yet.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Actions helper modal -->
  <div id="actionsHelperModal" class="token-modal-overlay" style="display:none">
    <div class="token-modal">
      <h2>Actions helper</h2>
      <div class="small" style="color:var(--muted);margin-bottom:12px">
        Copy the current tunnel URL and the Actions OpenAPI import URL. Import URL is masked on screen, but copy uses the full token.
      </div>

      <div class="actions-helper">
        <div class="actions-helper-row">
          <div class="actions-helper-field">
            <div class="small" style="margin-bottom:6px">Current tunnel URL</div>
            <input type="text" id="actionsHelperTunnelUrl" class="actions-helper-input" readonly placeholder="Not detected yet" />
          </div>
          <button class="primary actions-helper-copy" id="btnCopyActionsTunnelUrl" disabled>Copy tunnel URL</button>
        </div>

        <div class="actions-helper-row">
          <div class="actions-helper-field">
            <div class="small" style="margin-bottom:6px">Current OpenAPI import URL</div>
            <input type="text" id="actionsHelperImportUrl" class="actions-helper-input" readonly placeholder="Run tools\\studio-quick-tunnel.bat first" />
          </div>
          <button class="primary actions-helper-copy" id="btnCopyActionsImportUrl" disabled>Copy import URL</button>
        </div>

        <div class="row" style="gap:10px;align-items:center">
          <button id="btnRefreshActionsHelper" title="Re-detect tunnel URL">‚Üª Refresh</button>
          <span class="small" id="actionsHelperStatus">Tip: run <code>tools\\studio-quick-tunnel.bat</code> to start the tunnel and copy the import URL.</span>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:14px">
        <button id="btnActionsHelperClose">Close</button>
      </div>
    </div>
  </div>

  <!-- API token prompt (shown automatically on 401 if VP_API_TOKEN is set) -->
  <div id="apiTokenModal" class="token-modal-overlay" style="display:none">
    <div class="token-modal">
      <h2>API Token Required</h2>
      <div class="small" style="color:var(--muted);margin-bottom:10px">
        This Studio server requires a token (<code>VP_API_TOKEN</code>). Paste it to access <code>/api/*</code> endpoints.
      </div>
      <input type="password" id="apiTokenInput" placeholder="Paste token‚Ä¶" autocomplete="off" />
      <label class="small" style="display:flex;align-items:center;gap:8px;margin-top:10px">
        <input type="checkbox" id="apiTokenRemember" /> Remember on this device
      </label>
      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="btnApiTokenCancel">Cancel</button>
        <button class="danger" id="btnApiTokenForget">Forget</button>
        <button class="primary" id="btnApiTokenSave">Save</button>
      </div>
      <div class="small" id="apiTokenError" style="display:none;color:var(--danger);margin-top:10px"></div>
    </div>
  </div>

  <script src="/static/app.js"></script>
</body>
</html>
