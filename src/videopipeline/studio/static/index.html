<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VideoPipeline Studio</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- ===== HOME VIEW ===== -->
  <div id="homeView" style="display:none">
    <header>
      <h1>VideoPipeline Studio</h1>
      <span class="muted">Home</span>
    </header>
    <main class="home-main">
      <section class="home-section">
        <div class="panel home-panel">
          <h2>Open Video</h2>
          <div class="row" style="gap:10px">
            <button class="primary" id="btnOpenDialog">Browse for video...</button>
          </div>
          <div class="row" style="margin-top:15px;gap:10px">
            <input type="text" id="videoPathInput" placeholder="Or paste video path here..." style="flex:1;min-width:300px" />
            <button id="btnOpenByPath">Open</button>
          </div>
          <p class="small" style="margin-top:10px">Select a video file to create or open its project.</p>
        </div>

        <div class="panel home-panel">
          <h2>Download from URL</h2>
          <div class="row" style="gap:10px;align-items:center">
            <input type="text" id="urlInput" placeholder="Paste YouTube/Twitch/etc URL..." style="flex:1;min-width:300px" />
            <button id="btnPasteUrl" title="Paste from clipboard">üìã</button>
            <button id="btnProbeUrl" title="Detect site info">üîç Probe</button>
            <button class="primary" id="btnDownloadUrl">Download</button>
          </div>
          <div id="probeBadge" style="margin-top:8px;padding:8px 12px;background:#2a3a4a;border-radius:4px;display:none">
            <span id="probeBadgeText" class="small" style="color:#7fdbff"></span>
          </div>
          <div class="row" style="margin-top:10px;gap:15px;align-items:center;flex-wrap:wrap">
            <label class="small"><input type="checkbox" id="dlCreatePreview" checked /> Create preview</label>
            <label class="small"><input type="checkbox" id="dlNoPlaylist" checked /> No playlist</label>
            <label class="small" style="display:flex;align-items:center;gap:5px">
              Speed:
              <select id="dlSpeedMode" style="padding:2px 6px">
                <option value="auto" selected>Auto (recommended)</option>
                <option value="conservative">Conservative (N=4)</option>
                <option value="balanced">Balanced (N=8)</option>
                <option value="fast">Fast (N=16)</option>
                <option value="aggressive">Aggressive (N=32)</option>
              </select>
            </label>
            <label class="small" style="display:flex;align-items:center;gap:5px">
              Quality:
              <select id="dlQualityCap" style="padding:2px 6px">
                <option value="source" selected>Source (best)</option>
                <option value="1080">1080p</option>
                <option value="720">720p</option>
                <option value="480">480p</option>
              </select>
            </label>
          </div>
          <p class="small" style="margin-top:8px;color:#888">
            <span id="dlHelpText">Paste a URL and click Download. Auto mode adapts speed per site.</span>
          </p>
        </div>

        <div class="panel home-panel">
          <h2>Jobs</h2>
          <div class="list" id="homeJobs">
            <div class="small">No active jobs.</div>
          </div>
        </div>

        <div class="panel home-panel">
          <h2>Videos</h2>
          <div class="list" id="recentVideos">
            <div class="small">Loading...</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== STUDIO VIEW ===== -->
  <div id="studioView" style="display:none">
    <header>
      <h1>VideoPipeline Studio</h1>
      <span class="muted" id="projectInfo">Loading project...</span>
      <div class="tab-bar" style="margin-left:20px">
        <button class="tab-btn active" data-tab="edit" id="tabEdit">Edit</button>
        <button class="tab-btn" data-tab="publish" id="tabPublish">Publish</button>
      </div>
      <button id="btnBackToHome" style="margin-left:20px" title="Back to Home">‚Üê Home</button>
      <span class="muted" style="margin-left:auto">
        Shortcuts: <kbd>Space</kbd> play/pause, <kbd>I</kbd> set start, <kbd>O</kbd> set end, <kbd>[</kbd>/<kbd>]</kbd> nudge ¬±0.5s
      </span>
    </header>

    <!-- Edit Tab Content -->
    <main id="editTabContent">
      <section id="left">
        <div class="panel">
          <h2>Source video</h2>
          <div class="video-wrap">
            <video id="video" controls preload="metadata" src="/video"></video>
            <canvas id="facecamCanvas" class="overlay-canvas"></canvas>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="btnSetStart">Set Start = current</button>
            <button id="btnSetEnd">Set End = current</button>
            <button id="btnSnapCandidate" title="Snap in/out to candidate">Snap to candidate</button>
            <span class="small" id="timeReadout"></span>
          </div>
        </div>

        <div class="panel">
          <h2>Layout</h2>
          <div class="row">
            <button class="primary" id="btnCalibrateFacecam">Calibrate facecam</button>
            <button id="btnSaveFacecam" disabled>Save facecam</button>
            <span class="small" id="facecamStatus">No facecam calibration yet.</span>
          </div>
          <p class="small">Draw a rectangle around the facecam. Saved as normalized coordinates.</p>
        </div>

        <div class="panel">
          <h2>Interest timeline</h2>
          <div class="row">
            <button class="success" id="btnAnalyzeFull" title="Run all analysis stages in parallel (recommended)">‚ö° Analyze (Full)</button>
            <button class="primary" id="btnAnalyzeHighlights">Analyze highlights</button>
            <button id="btnAnalyzeAudio">Audio only</button>
            <button id="btnAnalyzeAudioEvents" title="Detect laughter, cheering, shouting events">Audio events</button>
            <button id="btnAnalyzeSpeech" title="Transcribe with Whisper and extract speech/reaction features">Speech</button>
            <button id="btnAnalyzeContext" title="Generate clip variants and AI titles/hooks">Context + Titles (AI)</button>
          </div>
          <div class="row">
            <span class="small" id="analysisStatus"></span>
          </div>
          <div class="canvas-wrap">
            <canvas id="chart" height="120"></canvas>
          </div>
          <p class="small">Higher score means more hype based on combined signals (audio energy + motion + chat spikes + audio events).</p>
        </div>

        <div class="panel">
          <h2>Jobs</h2>
          <div class="list" id="jobs"></div>
        </div>

        <div class="panel">
          <h2>Clip builder</h2>
          <div class="row">
            <label>Start (s)
              <input type="number" id="startS" step="0.1" />
            </label>
            <label>End (s)
              <input type="number" id="endS" step="0.1" />
            </label>
            <label>Title
              <input type="text" id="title" placeholder="Optional title" style="width:260px" />
            </label>
            <label>Template
              <select id="template">
                <option value="vertical_blur">vertical_blur (gaming default)</option>
                <option value="vertical_streamer_pip">vertical_streamer_pip (facecam PIP)</option>
                <option value="vertical_streamer_split">vertical_streamer_split (facecam split)</option>
                <option value="vertical_crop_center">vertical_crop_center</option>
                <option value="original">original</option>
              </select>
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="primary" id="btnSaveSelection">Save selection</button>
            <button id="btnNudgeBack">‚óÄ -0.5s</button>
            <button id="btnNudgeFwd">+0.5s ‚ñ∂</button>
            <span class="small">Tip: fine-tune with arrow keys in the inputs.</span>
          </div>
        </div>
      </section>

      <section id="right">
        <div class="panel" id="chatPanel">
          <h2>Chat Replay</h2>
          <div class="row" style="margin-bottom:10px;gap:8px;flex-wrap:wrap">
            <input type="text" id="chatSourceUrl" placeholder="Source URL (Twitch VOD, YouTube...)" style="flex:1;min-width:200px" />
            <button class="primary" id="btnDownloadChat">Download Chat</button>
            <button id="btnClearChat" style="display:none">Clear</button>
          </div>
          <div id="chatOffsetControls" class="row" style="margin-bottom:10px;gap:8px;align-items:center;display:none">
            <label style="display:flex;align-items:center;gap:5px">
              Offset (ms):
              <button id="chatNudgeBack" style="padding:2px 8px">-1s</button>
              <input type="number" id="chatOffsetMs" value="0" style="width:80px" />
              <button id="chatNudgeFwd" style="padding:2px 8px">+1s</button>
            </label>
            <label style="font-size:0.85em"><input type="checkbox" id="chatAutoScroll" checked /> Auto-scroll</label>
          </div>
          <div class="small" id="chatStatus">No chat replay available.</div>
          <div class="chat-messages" id="chatMessages"></div>
          <p class="small" style="margin-top:8px;opacity:0.7">Click a message to seek. Use offset to sync chat with video.</p>
        </div>

        <div class="panel">
          <h2>Top candidates</h2>
          <div class="list" id="candidates"></div>
        </div>

        <div class="panel">
          <h2>Batch actions</h2>
          <div class="row">
            <label>Top N
              <input type="number" id="batchTopN" value="10" min="1" />
            </label>
            <label>Template
              <select id="batchTemplate">
                <option value="vertical_streamer_pip">vertical_streamer_pip</option>
                <option value="vertical_streamer_split">vertical_streamer_split</option>
                <option value="vertical_blur">vertical_blur</option>
                <option value="vertical_crop_center">vertical_crop_center</option>
                <option value="original">original</option>
              </select>
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="primary" id="btnCreateSelections">Create selections from top candidates</button>
            <button id="btnBatchExport">Batch export selections</button>
          </div>
          <p class="small">Creates selections from top highlight candidates, then exports them sequentially.</p>
        </div>

        <div class="panel">
          <h2>Selections</h2>
          <div class="list" id="selections"></div>
        </div>

        <div class="panel">
          <h2>Export</h2>
          <div class="row">
            <label>Width
              <input type="number" id="expW" value="1080" />
            </label>
            <label>Height
              <input type="number" id="expH" value="1920" />
            </label>
            <label>FPS
              <input type="number" id="expFps" value="30" />
            </label>
            <label>CRF
              <input type="number" id="expCrf" value="20" />
            </label>
            <label>Preset
              <select id="expPreset">
                <option>veryfast</option>
                <option>faster</option>
                <option>fast</option>
                <option>medium</option>
              </select>
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <label><input type="checkbox" id="withCaptions" /> Burn-in captions (Whisper)</label>
            <label><input type="checkbox" id="normalizeAudio" /> Normalize audio</label>
          </div>
          <p class="small">Captions require optional dependency: <code>pip install -e '.[whisper]'</code></p>
        </div>
      </section>
    </main>

    <!-- Publish Tab Content -->
    <main id="publishTabContent" style="display:none">
      <section id="publishLeft">
        <div class="panel">
          <h2>Accounts</h2>
          <div class="row" style="margin-bottom:10px">
            <select id="publishPlatformFilter">
              <option value="">All platforms</option>
              <option value="youtube">YouTube</option>
              <option value="tiktok">TikTok</option>
            </select>
            <input type="text" id="publishAccountSearch" placeholder="Search accounts..." style="flex:1" />
          </div>
          <div class="list" id="publishAccounts">
            <div class="small">Loading accounts...</div>
          </div>
          <div id="noAccountsCard" class="panel" style="display:none;margin-top:12px;background:#1a1e24">
            <p class="small">No accounts connected yet.</p>
            <p class="small">Add an account via CLI:</p>
            <code class="small" style="display:block;padding:8px;background:#0f1318;border-radius:6px;margin-top:8px;word-break:break-all">vp accounts add youtube --client-secrets "path/to/client_secret.json" --label "My Channel"</code>
            <button id="btnCopyAccountCmd" style="margin-top:8px">Copy command</button>
          </div>
        </div>

        <div class="panel">
          <h2>Publish Options</h2>
          <div class="row">
            <label>Privacy
              <select id="publishPrivacy">
                <option value="private">Private</option>
                <option value="unlisted">Unlisted</option>
                <option value="public">Public</option>
              </select>
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <label style="width:100%">Title override (optional)
              <input type="text" id="publishTitleOverride" placeholder="Leave blank to use metadata title" style="width:100%" />
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <label style="width:100%">Description override (optional)
              <textarea id="publishDescOverride" placeholder="Leave blank to use metadata description" rows="3" style="width:100%;resize:vertical"></textarea>
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <label style="width:100%">Append hashtags (optional)
              <input type="text" id="publishHashtags" placeholder="#shorts #gaming" style="width:100%" />
            </label>
          </div>
          <details style="margin-top:12px">
            <summary class="small" style="cursor:pointer">Batch options</summary>
            <div class="row" style="margin-top:10px">
              <label>Stagger (seconds between posts)
                <input type="number" id="publishStagger" value="0" min="0" />
              </label>
            </div>
          </details>
        </div>

        <div class="panel">
          <h2>Actions</h2>
          <div class="row">
            <button class="primary" id="btnQueuePublish">Queue publish</button>
            <span class="small" id="publishSelectionInfo">Select exports and accounts above</span>
          </div>
        </div>
      </section>

      <section id="publishRight">
        <div class="panel">
          <h2>Exports</h2>
          <div class="list" id="publishExports">
            <div class="small">Loading exports...</div>
          </div>
        </div>

        <div class="panel">
          <h2>Publish Jobs</h2>
          <div class="list" id="publishJobs">
            <div class="small">No jobs yet.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="/static/app.js"></script>
</body>
</html>
